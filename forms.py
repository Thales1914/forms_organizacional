import streamlit as st
from datetime import datetime
from config import SETORES, PESOS
from db import conectar

def formulario():
    conn = conectar()
    cursor = conn.cursor()

    st.title("üìã Pesquisa de Avalia√ß√£o de Colaboradores")

    setor = st.selectbox("üìÇ Selecione o setor", list(SETORES.keys()))
    colaborador = st.selectbox("üë• Selecione o funcion√°rio avaliado", SETORES[setor])
    data = datetime.today().strftime("%d/%m/%Y")

    with st.form("pesquisa", clear_on_submit=True):

        st.subheader("‚ú® Informa√ß√µes iniciais")
        p1 = st.text_area("1Ô∏è‚É£ Pontos fortes e valores do colega", key="p1")
        p2 = st.text_input("2Ô∏è‚É£ Palavra-chave que define o colega", key="p2")

        st.subheader("ü§ù Colabora√ß√£o e Rela√ß√µes")
        p3 = st.radio("3Ô∏è‚É£ Rela√ß√£o com a equipe", list(PESOS["p3"].keys()), horizontal=True, key="p3")
        j3 = st.text_area("Justifique", key="j3")

        p4 = st.radio("4Ô∏è‚É£ Sua rela√ß√£o com o colega", list(PESOS["p4"].keys()), horizontal=True, key="p4")
        j4 = st.text_area("Justifique", key="j4")

        p5 = st.radio("5Ô∏è‚É£ Colabora com a equipe?", list(PESOS["p5"].keys()), horizontal=True, key="p5")
        j5 = st.text_area("Justifique", key="j5")

        st.subheader("üöÄ Atitudes e Desempenho")
        p6 = st.radio("6Ô∏è‚É£ Interage com a equipe?", list(PESOS["p6"].keys()), horizontal=True, key="p6")
        j6 = st.text_area("Justifique", key="j6")

        p7 = st.radio("7Ô∏è‚É£ √â proativo?", list(PESOS["p7"].keys()), horizontal=True, key="p7")
        j7 = st.text_area("Justifique", key="j7")

        p8 = st.radio("8Ô∏è‚É£ Gerencia bem o tempo/tarefas?", list(PESOS["p8"].keys()), horizontal=True, key="p8")
        j8 = st.text_area("Justifique", key="j8")

        st.subheader("üó£Ô∏è Comunica√ß√£o e Conflitos")
        p9 = st.radio("9Ô∏è‚É£ Comunica√ß√£o com equipe/√°reas", list(PESOS["p9"].keys()), horizontal=True, key="p9")
        j9 = st.text_area("Justifique", key="j9")

        p10 = st.radio("üîü Contribui para resolu√ß√£o de conflitos?", list(PESOS["p10"].keys()), horizontal=True, key="p10")
        j10 = st.text_area("Justifique", key="j10")

        st.subheader("üèÜ Resultados e Sugest√µes")
        p11 = st.radio("1Ô∏è‚É£1Ô∏è‚É£ Contribui√ß√£o para sucesso da empresa", list(PESOS["p11"].keys()), horizontal=True, key="p11")
        j11 = st.text_area("Justifique", key="j11")

        p12 = st.text_area("1Ô∏è‚É£2Ô∏è‚É£ Sugest√µes para desenvolvimento", key="p12")

        mostrar_resumo = st.checkbox("üîé Visualizar resumo das respostas antes de enviar")

        submitted = st.form_submit_button("‚úÖ Enviar Resposta")

        if submitted:
            obrigatorios = {
                "Pontos fortes": p1,
                "Palavra-chave": p2,
                "Justificativa Q3": j3,
                "Justificativa Q4": j4,
                "Justificativa Q5": j5,
                "Justificativa Q6": j6,
                "Justificativa Q7": j7,
                "Justificativa Q8": j8,
                "Justificativa Q9": j9,
                "Justificativa Q10": j10,
                "Justificativa Q11": j11,
                "Sugest√µes": p12
            }

            faltando = [campo for campo, valor in obrigatorios.items() if not valor.strip()]

            if faltando:
                st.error(f"‚ö†Ô∏è Os seguintes campos s√£o obrigat√≥rios e precisam ser preenchidos: {', '.join(faltando)}")
            else:
                score_bruto = sum([
                    PESOS["p3"].get(p3, 0),
                    PESOS["p4"].get(p4, 0),
                    PESOS["p5"].get(p5, 0),
                    PESOS["p6"].get(p6, 0),
                    PESOS["p7"].get(p7, 0),
                    PESOS["p8"].get(p8, 0),
                    PESOS["p9"].get(p9, 0),
                    PESOS["p10"].get(p10, 0),
                    PESOS["p11"].get(p11, 0),
                ])
                score_max = 9 * 4
                score = round((score_bruto / score_max) * 100, 2)

                cursor.execute("""
                INSERT INTO respostas (
                    setor, colaborador, data,
                    p1, p2, p3, j3, p4, j4, p5, j5, p6, j6,
                    p7, j7, p8, j8, p9, j9, p10, j10, p11, j11, p12, score
                ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                """, (setor, colaborador, data, p1, p2, p3, j3, p4, j4, p5, j5,
                      p6, j6, p7, j7, p8, j8, p9, j9, p10, j10, p11, j11, p12, score))
                conn.commit()

                if mostrar_resumo:
                    st.success("‚úÖ Resposta registrada! Veja abaixo o resumo:")
                    st.write(f"**Setor:** {setor}")
                    st.write(f"**Colaborador avaliado:** {colaborador}")
                    st.write(f"**Data:** {data}")
                    st.write(f"**Pontua√ß√£o:** {score} / 100")
                    st.write("---")
                    st.write(f"**P1:** {p1}")
                    st.write(f"**P2:** {p2}")
                    st.write(f"**P3:** {p3} | Justificativa: {j3}")
                    st.write(f"**P4:** {p4} | Justificativa: {j4}")
                    st.write(f"**P5:** {p5} | Justificativa: {j5}")
                    st.write(f"**P6:** {p6} | Justificativa: {j6}")
                    st.write(f"**P7:** {p7} | Justificativa: {j7}")
                    st.write(f"**P8:** {p8} | Justificativa: {j8}")
                    st.write(f"**P9:** {p9} | Justificativa: {j9}")
                    st.write(f"**P10:** {p10} | Justificativa: {j10}")
                    st.write(f"**P11:** {p11} | Justificativa: {j11}")
                    st.write(f"**P12:** {p12}")
                else:
                    st.success(f"‚úÖ Resposta registrada com sucesso! Pontua√ß√£o normalizada: {score}")
